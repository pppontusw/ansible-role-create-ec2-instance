- ec2:
    key_name: "{{ec2_key_name}}"
    instance_type: "{{ec2_instance_type}}"
    image: ami-0d77397e
    group: "{{ec2_security_group}}"
    instance_tags: 
      Name: "{{app_name}}-{{ ansible_date_time.iso8601 | regex_replace('[^a-zA-Z0-9]', '-') }}"
    vpc_subnet_id: "{{ec2_subnet}}"
    region: "{{ec2_region}}"
    assign_public_ip: "{{assign_public_ip}}"
    wait: yes
  register: ec2
  
- add_host: 
    hostname: "{{item.private_ip}}" 
    groupname: launched
  with_items: "{{ec2.instances}}"
  when: not assign_public_ip

- add_host: 
    hostname: "{{item.public_ip}}" 
    groupname: launched
  with_items: "{{ec2.instances}}"
  when: assign_public_ip

- debug:
    msg: "{{ec2}}"

- wait_for: 
    host: "{{item.private_ip}}"
    port: 22
    delay: 60
    timeout: 320
    state: started
  with_items: "{{ec2.instances}}"
  when: not assign_public_ip

- wait_for: 
    host: "{{item.public_ip}}"
    port: 22
    delay: 60
    timeout: 320
    state: started
  with_items: "{{ec2.instances}}"
  when: assign_public_ip